# DeFaaS: An Open and Fair FaaS Platform based on Blockchain

## 摘要

云计算是一种重要的使用计算资源的方式。云计算的传统商业模式是，租户付费使用云供应商所建立的数据中心里的计算资源。这种商业模式有两个缺点。一个缺点是，租户有时会闲置了他所购买的云计算资源，这对于租户来说是资源浪费和经济损失。如果闲置计算资源的所有者能够成为供应商，把资源出售给需要的人，那么就可以提高计算资源的利用率和增加资源所有者的利益。另一个缺点是，租户难以对中心化的云供应商的服务水平进行有效的监督。在计算资源的交易中，如果有一个可信的第三方来进行监督供应商的服务水平，那么对租户就更加公平。区块链技术的出现，使得我们可以克服上述两种缺点。本文基于区块链技术，设计了一个开放公平的 FaaS 平台。开放体现在，任何人可以成为计算资源的供应商和租户，供应商通过运行函数服务的方式提供计算资源，租户通过部署函数服务的方式消费计算资源。本平台基于博弈论的分析，提供了可信的服务水平协议，与中心化的云供应商相比，对租户更加公平。



Cloud computing is an important way to use computing resources. The traditional business model of cloud computing is that customers pay to use the computing resources in the data center established by the cloud provider. There are two drawbacks to this business model. One disadvantage is that the customer sometimes idle the cloud computing resources he purchased, which is a waste of resources and economic loss for the customer. If the owner of idle computing resources can become a provider and sell the resources to the people in need, then the utilization rate of computing resources can be improved and the income of resource owners can be increased. Another disadvantage is that it is difficult for customers to effectively monitor the service level of centralized cloud providers. In the transaction of computing resources, if there is a trusted third party to monitor the service level of the provider, it will be more fair to the customers. The emergence of blockchain technology enables us to overcome the above two shortcomings. This paper designs an open and fair FaaS platform based on blockchain technology. Openness is reflected in that anyone can become a provider and customer of computing resources. The provider provides computing resources by running function services, and the customer consumes computing resources by deploying function services. Based on the analysis of game theory, this platform provides a credible service level agreement, which is more fair to customers than centralized cloud providers.



关键词：Blockchain，FaaS，Ethereum



## 1. 背景

### 1.1 选题背景与意义

人们正面临着计算资源需求和计算资源利用率不匹配的问题。

一方面，随着信息技术的发展和互联网应用的繁荣，人们产生的数据量越来越大，处理这些数据的程序越来越复杂，消耗的计算资源越来越多，对计算资源的需求越来越大。（引）

另一方面，计算资源利用率不高。一是因为计算设备分布的问题，地理分散，规模零散，互不信任的私有计算设备难以统一维护管理，它们之间难以通过共享协作，负载均衡的方式来提高计算资源利用率；所以出现了云计算的商业模式，云供应商建立计算资源集约化的数据中心，向用户出租计算资源和出售软件服务（引）。二是计算资源闲置的问题，对于私有计算设备来说，它们的利用率通常不高（引），而即使对于公有云的租户来说，租户也有可能把从云供应商处租用的计算资源闲置了，这对于租户来说是经济损失，也意味着资源的浪费（引）。如果有一个开放的平台，闲置计算资源的所有者可以通过它成为供应商，把资源出售给需要的人，那么就可以提高整体计算资源的利用率和增加所有者的收益。

此外，还需要注意到，在云计算的传统商业模式中，租户缺乏对供应商违反服务水平协定的证明方式和处理方法，难以对中心化云供应商的服务水平进行有效的监督（引）。这对于租户来说是不透明的和不公平的。



基于对区块链技术和 FaaS 的认识，我们提出了对于上述问题的一种解决方案。

本文基于区块链技术，设计了一个开放公平的 FaaS 平台，人们可以通过本平台以函数服务的形式交换和使用计算资源。

- 开放体现在，任何人可以成为租户，任何人可以成为供应商。
- 通过本平台，租户能以部署函数服务的方式消费计算资源，供应商能以为租户运行函数服务的方式提供计算资源。
- 本平台在租户和供应商之间提供了可信的服务水平协议，与中心化的云供应商相比，本平台对租户更加公平。



图-1（链）是本 FaaS 平台的 **用例图**，它包含所有顶层约束。



![](./defaas-imgs/Usecase.svg)



### 1.2 智能合约的背景

本平台以区块链为基础，通过区块链与智能合约具有的去中心化，不可篡改，自动执行等技术特性解决开放环境下参与者对合作规则的信任问题。

区块链可以被描述为一个在网络中由许多计算机节点更新和共享的公共数据库。区块链网络中每个节点都有相同的数据副本，任何添加到区块链中的数据必须得到网络中的每个节点的一致同意，节点之间达成一致的方法是区块链的共识机制。（引 https://ethereum.org/en/developers/docs/intro-to-ethereum/#what-is-a-blockchain）

智能合约是一种运行在区块链上的程序。用户可以编写一个智能合约，并把它部署到区块链网络上；智能合约一旦部署后就只会按它所包含的代码运行，合约自动执行，不受用户控制（引 https://ethereum.org/en/developers/docs/smart-contracts/）。

在本平台的业务逻辑中，供应商提供计算资源，租户消费计算资源，两者之间的交易，需要在一个“合作规则”下进行。在一个任何人可以成为租户或供应商的陌生开放环境中，这个“合作规则”要能够得到租户们和供应商们的信任，而使用区块链技术，可以构建参与者对“合作规则“的信任。区块链建立在共识之上，对链上数据的修改是去中心化的，没有一方能单独篡改区块链上的数据，所以链上数据的公开透明产生了信任；智能合约是不可变的”合作规则“，智能合约的自动执行是”规则“的严格执行，所以“规则的不可变”和“规则执行的不可操纵”产生了信任。

本平台使用智能合约实现租户与供应商之间交易计算资源的的业务逻辑，即把智能合约作为租户与供应商”合作规则“的形式，解决了开放环境中租户与供应商对平台的信任问题。



### 1.3 FaaS 的背景

**FaaS 是什么**

微服务（MicroService）是以专注于单一功能的小型服务为基础，通过组合多个小型服务构建出复杂的大型应用程序的一种软件架构。而 FaaS 的软件架构理念则更加碎片化的，把程序逻辑拆分为比微服务更加细小的代码片段，称为“函数（Function）”。（引 https://aws.amazon.com/cn/blogs/china/iaas-faas-serverless/）“函数”是无状态的。

从运维上讲，“函数”可以按需创建，并且粒度更小成本更低，所以 FaaS 构架的系统具有很好的扩展性和弹性；同时，“函数”作为应用程序的一个高层抽象，屏蔽了计算资源和服务器的细节，使程序员无需考虑应用程序所在的服务器。这些是 FaaS 的优势。

从编程范式上讲，FaaS 与由来已久的函数式编程并无不同，函数式编程把程序分为数据和函数两部分，通过函数的层层嵌套构成算法，完成数据从源到结果的映射描述（引）；函数式编程要求程序员用函数的规则描述具体的领域问题，而领域问题不一定不适合这种形式化的表达，所以设计 FaaS 架构的应用程序会更加困难。

目前，FaaS 常用于实现 AI 推理服务和图像处理服务。（引）



图-2 FaaS 工作流程

![](defaas-imgs/FaaS-Usecase.svg)



**为什么是 FaaS**

本平台把 FaaS 作为使用计算资源的形式，是因为其 无状态 和 Serverless 的特点。

- 无状态意味着供应商不需要持久化存储租户的数据，不消耗存储资源，而只消耗处理器内存等可以重复使用的计算资源。同时，也规避了用户数据隐私泄露，数据所有权纷争等问题，特别是在一个任何人成为租户和供应商的开放的环境里。
- Serverless 意味着开发者无须关系复杂的服务器细节，租户可以专注于函数逻辑的编写。





### 1.4 本文的论文结构和章节安排

本文共分为八章，各章节内容安排如下：

- 第一章为背景。说明了选题背景与意义，以及智能合约和 FaaS 的背景。
- 第二章为本文的概述。介绍本设计的核心概念和整体设计。
- 第三章介绍本 FaaS 平台的设计，分为两个部分。
  - 第一部分是去中心化的 FaaS 市场，说明本平台的开放。
  - 第二部分是可信的服务水平协议，说明本平台的公平。
- 第四章介绍了基于本设计的扩展工作。
- 第五章介绍了本设计的原型实现。
- 第六章指出了本设计的一些不足。
- 第七章介绍了相关工作。
- 第八章是结论与展望。



------

## 2. 概述

### 2.1 概念介绍

#### 2.1.1 账户

对于不同的参与者，本平台使用账户把它们区别开来，每一个账户代表一个参与者。本平台基于采用公私钥体系的区块链，区块链的账户就是本平台的账户。根据非对称加密技术，一个账户对应着一对公钥和私钥，由公钥经过安全单向的计算后得到地址字符串被用作账户的账户地址。任何人可以自行生成区块链的账户参与到本平台中，不需要经过任何请求和审核。



#### 2.1.2 角色

一个账户可以扮演三种角色：

- 租户（ Customer）

  租户能发出部署函数服务的订单，以部署函数服务的方式消费计算资源。

- 供应商（Provider）

  对于租户发出的函数服务的订单，供应商提供计算资源来运行这些函数服务。每一个供应商有一个信誉值，当供应商存在违规行为，他的信誉值会下降。

- 证人（Witness）

  证人监测供应商运行的函数服务并向平台报告，为 FaaS平台维持可信的服务水平协议。每一个证人有一个信誉值，当证人存在违规行为，他的信誉值会下降。
  
  

#### 2.1.3 FaaS Token

本平台设计了一个符合 ERC20 标准（引）的 Token 合约，创造了一种名为 FaaS Token 的代币。

FaaS Token 是一种仅可用于本平台的货币，作为一种电子形式的价值符号，它有两个作用：

- 作为租户消费计算资源的支付手段。租户需要为其部署的函数服务支付 FaaS Token 给平台，而供应商通过为租户运行函数服务来从平台获取 FaaS Token。
- 作为质押资产。一个账户可以注册成为供应商或证人，注册过程中他必须质押一定数目的 FaaS Token 给平台；当他注销供应商或证人资格时，他可以如数取回押金。但是，如果他在作为供应商或证人的过程中存在违规行为，导致信誉不合格，就不能取回押金。

在本 FaaS 平台中，FaaS Token 有两个含义，一是交换计算资源的媒介（media），二是使用计算资源的权力（power）。

每一个账户都有一个 FaaS Token 的余额，一个账户的收入会被添加到这个余额，支出从这个余额扣除。



### 2.2 整体设计

如下图，整体上看，本平台设计了：

- 两个智能合约：Market 合约 和 WitnessPool 合约
- 三种角色的客户端：租户，供应商，证人

通过三种角色和两个智能合约的交互，形成了一个可信的 FaaS 算力市场，来完成 1.1 中陈述的用例。



图-3 关系图，图中左半部分将在章节 3.1 中详细介绍，右半部分将在章节 3.2 中详细介绍。



<img src="./defaas-imgs/Overview-Design.svg" style="zoom:150%;" />







## 3. DeFaaS

### 3.1 去中心化的 FaaS 市场

租户和供应商同 Market 合约的交互形成了一个去中心化 FaaS 市场。

为了部署函数服务，租户需要先向 Market 合约发出部署请求；再经过一系列的智能合约交互，租户与供应商之间达成租约和服务水平协议，供应商开始为租户运行函数服务；最后，当函数服务结束，Market 合约会为双方完成结算和转账。

#### 3.1.1 FaaS 规格

Market 合约维护了一个类似于表-1（链）的 FaaS 规格表（FaaS Level），指明一个函数服务所需要的计算资源规格。

租户想要部署一个函数服务，需要在部署请求中指明一个 FaaS 规格的 ID。

对于 FaaS 规格表，只允许创建新的表项，不允许修改任何已存在的表项。我们预设 FaaS 平台有一个负责维护 FaaS 规格表 的管理员，管理员可以通过给 FaaS 规格表添加新的表项，提供更加丰富的计算类型和更加精细的资源粒度。



表-1 *FaaS 服务规格表*

| FaaS 规格 ID | CPU核心数 | GPU计算能力 | 使用内存（MB） | 部署包大小（MB） | 标签     | 其他字段 |
| ------------ | --------- | ----------- | -------------- | ---------------- | -------- | -------- |
| 0            | 1         | 0           | 512            | 50               | normal   | ...      |
| 1            | 1         | 0           | 1024           | 100              | normal   | ...      |
| 2            | 2         | 0           | 2048           | 200              | graphics | ...      |
| 3            | 1         | 10          | 4096           | 500              | ai       | ...      |
| ...          | ...       |             | ...            | ...              |          | ...      |



#### 3.1.2 计费规则

FaaS 的优势之一是弹性，对于有弹性需求的场景，理当是按需使用，产生的费用由 function 实际调用次数决定，服务费用不能提前确定，而在开放的环境下，由供应商记录的调用次数又是不可信的。

对于租户在本平台部署函数服务的计费规则，我们做了简化，舍去 FaaS 弹性的优势，按照服务时长来计费，更适合的是大任务离线计算这类函数计算需求，而非弹性计算的场景。可以说，安全性限制了本平台的应用范围。



如在 2.1.2 中所述，租户需要为其部署的函数服务支付 FST 给平台，其计费规则如下：
$$
ServiceFee =  ServiceDuration  \times UnitPrice
$$
其中，

- ServiceFee 是租户部署一个函数服务需要支付给 FaaS 平台的 FaaSToken 数目。
- ServiceDuration  是 FaaS 服务时长，以小时为单位。
- UnitPrice 是服务单价，即每小时的单价，不同的 FaaS 规格有不同的单价。



#### 3.1.3 竞价匹配机制

供应商可以通过监听 Market 合约的事件来获取租户发出的新部署订单的信息。

我们说一个部署订单被匹配了（Matched），当 Market 合约决定由某一个供应商来运行部署订单对应的函数服务。那么，如何决定是哪一个供应商？**部署订单的匹配是通过供应商之间的竞争来完成的。**如 3.1.1 所述的计费规则，服务费用是服务时间和服务单价的乘积；供应商之间要竞争的内容是服务单价，要价越低的供应商越有可能获得订单。

竞价匹配规则如下：

- 对于一个部署订单，在订单指定的竞标时间内，供应商可以对该订单的**投标**（Bid），即向 Market 提交一个服务单价，为供应商为租户运行函数服务的要价。
- 当订单指定的竞标时间到达后，Market 合约上会产生匹配结果：
  - 如果竞标期间没有一个供应商对该订单投标，那么说明没有供应商愿意为此订单运行函数服务，订单**匹配失败**。
  - 只要存在至少一个供应商对该订单投标，订单就可以**匹配成功**。一个订单有多个供应商对其投标，则要价最低的供应商胜出；相同要价下，更早投标的供应商胜出。



> 供应商之间的秘密竞价（这是重要细节，用于保护竞价的逻辑，但又过于具体，不知道要不要写进论文）
>
> 秘密竞价指供应商之间的出价是秘密，可以防止供应商形成卖方联盟，我们将介绍怎么在数据公开的区块链上实现秘密竞价。
>
> https://solidity-cn.readthedocs.io/zh/develop/solidity-by-example.html#id5





#### 3.1.4 Market合约的数据结构

本平台中，租户想要部署一个函数服务，他要先发出一个新建部署订单的请求给 Market 合约。Market 合约在受到部署请求后会新建一个**部署订单**（Deployment Order）并产生事件，部署订单记录了租户指定的 FaaS 规格，FaaS 服务时长，租户可接受的最高单价等信息。供应商们通过监听 Market 合约上的事件，可以获知新部署订单的信息。

当一个部署订单匹配成功，说明租户与供应商谈好了价钱。对于一个函数服务，租户与供应商之间还需要协商的服务的访问地址**，**访问密钥等细节，这些细节称为**部署信息**（Deployment Information）。

在一个部署订单匹配成功后，租户和供应商会协商好部署信息并确认，在这之后，Market 合约会为租户与供应商新建**租约**（Lease），租约记录了双方的账户地址，供应商应得服务报酬，供应商是否违反 SLA 等信息。

部署订房，部署信息，租约是租户与供应商之间交易计算资源的三个核心数据结构。



图-4（链），显示了Market 合约在链上维护了部署订单表，部署信息表，租约表，FaaS 规格表这四个表，前三者都以 部署订单ID 为主键。

<img src="./defaas-imgs/Market-Core-Data.svg"  />





#### 3.1.5 Market合约的交互

**部署订单的有限状态机**

函数服务的部署订单由租户发起，一个部署订单有五个状态：

- Bidding（竞标中），本状态以租户调用 Matket 合约的 new 函数**新建部署订单**为开始，以竞价终止为结束
- Confirming（确认中），本状态以部署订单匹配成功为开始，在本状态中供应商和租户确认订单并提供部署信息，以**新建租约**为结束
- Deploying（部署中），本状态以新建租约为开始，在本状态中，链下租户到供应商完成部署，以供应商触发Fulfilling状态为结束
- Fulfilling（履行中），本状态由供应商触发，在状态中，Market 合约新建 SLA，证人监督供应商，以任意人触发 Finished 状态结束
- Finished（已结束），为终止状态，此状态中已完成结算并转账，部署请求生命周期终止

在 Market 合约中，部署请求的生命周期由图-5（链）的有限状态机控制。图中，

- C 表示租户（Customer），P 表示供应商（Provider），X 表示任何人
- C-> new 表示租户调用 Market 合约的 new 函数，诸如此类



部署请求的状态转换动作发生在 图-6 （链）所示的图-6 所示的租户，供应商和 Matket合约的交互过程中。



图-5（链）部署请求的有限状态机



<img src="./defaas-imgs/Deployment-FSM.svg"  />





图-6（链）Market 交互的序列图

<img src="./defaas-imgs/Market-v2.svg" style="zoom:150%;" />





**支付结算流程**

在部署请求的生命周期中，资金转账流程为：

1. 租户调用 FaaS Token 合约的 approve（引），授权足够额度给 Market 合约
2. 租户向 Market 合约发出新建部署订单的请求，Market 合约调用 FaaS Token 合约的 transferFrom，锁定租户的预付款。预付款是租户可能支付的最高服务费的两倍。
4. 租户购买的函数服务到期，供应商履行租约结束，Market 合约完成本次订单的结算和转账。Market 合约将从预付款中向租户收取服务费，并把剩下的预付款退还给租户；同时 Market 合约支付服务报酬给供应商。



### 3.2 可信的服务水平协议

#### 3.2.1 SLA

本 FaaS 平台是开放的，所有人都可以参与其中，得益于区块链技术，平台的合作规则得到了参与者的信任。

然而，在业务层面，一个陌生的租户把函数服务交给一个陌生的供应商运行，我们也面临着一个中心化云供应商面临的信任问题：**供应商是否诚实地为租户运行函数服务？** 更具体地，供应商到底有没有运行函数服务？供应商提供的计算资源符合部署订单指明的 FaaS 规格吗？供应商运行的函数服务的可用性如何？这些需求指标和性能指标可以总结为**服务水平协议（Service Level Agreement，SLA）**。

相比于中心化的云供应商，如果本平台能够提供可信的 SLA，对租户就会更加公平。那么，在一个开放的环境中，FaaS 平台如何保证 SLA 是可信的？如何判断供应商违反了SLA？

一个直观的想法是，可以引入独立与租户和供应商的第三方机构来**监测**（Monitoring）供应商的函数服务，从而判断供应商是否违约。但是首先，我们不能引入一个中心化的第三方来实施监测，因为中心化的第三方不被信任。本平台解决了这一信任问题，通过引入**证人机制**，一个去中心化的第三方。“证人机制”这个想法来自于 [Blockchain based Witness Model](https://pure.uva.nl/ws/files/42160225/Blockchain_based_Witness_Model.pdf)（引）。



#### 3.2.2 WitnessPool 合约

如章节 2.1.2 中介绍，一个账户还可以扮演“证人”这种角色。租户和供应商是本平台的用例角色，而证人是一种内部角色，租户和供应商在使用本平台时完全不需要感知证人的存在。本平台设计了一个 Witness 合约，它有两个作用，管理证人和执行 SLA。为了管理证人，Witness 合约维护了一个“证人池”的数据结构来存储所有证人的信息，账户可以通过注册获得证人资格，加入到证人池中。

证人的职责是监测供应商运行函数服务的情况并向 WitnessPool 合约报告**监测结果**。监测结果是一个布尔值。一个证人报告的监测结果为 True，表示他认为他所监测的供应商违约了；监测结果为 False 则表示证人认为供应商没有违约。

在本平台中，当一个租户和一个供应商产生租约且完成链下部署后，供应商将为租户运行一个函数服务，然后告知 FaaS 平台服务已经开始。当 FaaS 平台得知服务已经开始后，WitnessPool 合约将从证人池中随机无偏地抽选出 N 个证人，组成一个**证人委员会**（Wintess Committee）。在一个函数服务的 SLA 执行过程中，证人委员会里的证人会独立监测函数服务，然后向 WitnessPool 合约报告自己的监测结果。

证人委员会的人数 N（N >= 3）是可以指定的。假设一个证人委员会包含了 N 个证人，他们分别监测函数服务并向 WitnessPool 合约报告监测结果。 WitnessPool 合约以如下规则判定供应商是否违约：

- 对应一个 N，WintessPool 合约中会规定一个相对多数 M（N/2 < M < N），比如说 N = 3， M = 2
- 如果证人委员会中认定供应商违约的证人人数 W >= M，那么 WitnessPool 合约就认定供应商违反 SLA（Violated）；反之则不违反（NoViolated）。



图-7 交互图

<img src="./defaas-imgs/Witness.svg" style="zoom:150%;" />



#### 3.2.3 证人收益函数与博弈论分析

被选中到证人委员会里的证人可以通过报告监测报告从 FaaS 平台获得以 FaaS Token 为形式的报酬。对于不同的违约判定结果和不同的监测报告，证人获得的收益是不同的，我们使用 [Blockchain based Witness Model](https://pure.uva.nl/ws/files/42160225/Blockchain_based_Witness_Model.pdf) 设计的收益函数作为本平台的证人收益函数。

记 WitnessPool 合约认定供应商是否违约的值为 S，S = Violated 或者 S = NoViolated；对于一个证人，记他的监测报告为 R，R = True 或 R = False。那么，一个证人的收益函数如表-2（链）所示：

| S \  R     | True | False |
| ---------- | ---- | ----- |
| Violated   | 10   | 0     |
| NoViolated | -1   | 1     |

对于一个 SLA 执行，证人委员会中 N 个证人的监测报告形成了一个一回合的 N-玩家完全信息静态博弈（引）。每一个玩家是对等的，其策略空间只有两个策略，一个是 R = True，另一个是 R = False。

在论文[Blockchain based Witness Model](https://pure.uva.nl/ws/files/42160225/Blockchain_based_Witness_Model.pdf) 中，证明了这个N-玩家博弈有且仅有两个纳什均衡（引）；一个纳什均衡是所有证人都采取策略 R = True，即都报告供应商违约；另一个纳什均衡是所有证人都采取策略 R = False，即都报告供应商不违约。

> 其实这个证明非常简单，可以考虑把证明放入附录，不过这样有抄袭之嫌。

一个证人为了最大化收益，会选择符合纳什均衡的策略，但是令他难以判断的是，其他证人是都选择 True，还是都选择 False；对于一个证人来说，最好的方法是根据监测情况如实报告，因为他和其他的所有证人都看到同样的现实。

所以，通过博弈论的分析我们可以看到，尽管单个证人是不可信的，可能存在一些证人胡乱报告监测结果，但是由于证人之间的博弈制衡，证人委员会里的证人为了最大化收益，都将按照实际情况报告供应商是否违约。这样，证人委员会就成为了一个去中心化的可信第三方，依靠这个第三方， 本 FaaS 平台维持了可信的 SLA，从而对租户更加公平。



#### 3.2.4 FaaS Token 增发机制

证人的数量是影响 FaaS 平台 SLA 可信度的一个因素。证人越多，从全部证人中随机抽选出证人委员会的结果就会更加稀疏和安全，FaaS 平台的 SLA 的可信度就越高。为了吸引大量的人加入 FaaS 平台的证人池，本平台以通过对证人发放收益的方式来铸币，也就是说，FaaS 平台会“凭空”增发 FaaS Token 来支付证人的监测收益，需要支付多少监测收益就增发多少 FaaS Token；证人的监测收益不由租户或者供应商承担。并且，支付证人的监测收益是 FaaS Token 的唯一增发方式，除此之外，没有其他方式可以“凭空”增加 FaaS Token 的发行量。

所以，本平台的 FaaS Token 是一种长期通胀的货币，但是这种通胀不是一种主动的通胀和盲目泛滥的货币增发；而是一种被动的通胀和精确节制的货币增发：只有租户与供应商之间发生计算资源交易并且证人诚实执行监测的时候，证人才能获得收益，FaaS Token 的增发才会发生。证人为本平台执行监测函数服务的工作，类似于比特币网络中矿工的挖矿（引），FaaS Token 的增发不是凭空的，而是 PoW 。但是 FaaS Token 与比特币有明显的不同。比特币网络通过矿工挖矿产生的新的区块来增发新的比特币，但是所能挖到的比特币是随时间递减的，并且最终比特币总量将不会再增加（引）。所以，比特币是一种通缩的货币，它不适合作为支付手段并在市场中大量流通，因为比特币不可能再增加了，“物以稀为贵”，人们更倾向于大量贮藏它们，而不是把它们用于购买商品，这弱化了货币是商品交换媒介的职能；这个逻辑是金本位货币体系崩溃的背后原因（引），也是本平台将 FaaS Token 设计为被动通胀的原因。





#### 3.2.5 重要细节

##### 3.2.5.1 保证静态博弈的假设

博弈的假设是博弈结论成立的条件，只有保证博弈的假设，我们在章节 3.2.4 提到的博弈论结论才能成立。

首先，需要注意到，区块链的公开透明特性与静态博弈假设的冲突。静态博弈的一个假设是：玩家不知道其他玩家采取了什么策略。但是，在区块链上任何信息都是公开的，所以证人不可以把自己的监测结果直接发送到区块链上，因为先报告的证人的报告结果会被晚报告的证人可以看到，这就破坏了博弈的假设。

幸运的是，我们可以使用类似于盲拍的技术，来实现静态博弈的“玩家不知道其他玩家采取了什么策略”这个假设。

我们把证人上报监测结果分为两个阶段，一个是秘密报告阶段，另一个是披露阶段。

- 在秘密报告阶段，证人向 WitnessPool 合约发送一个哈希值 H，H 是监测结果的秘密报告，智能合约只接受该阶段的秘密报告。
- 在披露阶段，证人向合约发送监测结果布尔值 R，一个时间值 T 和 一个密钥 S，WitnessPool 合约将检查两个条件，一个是 H = hash(R, T, S) ，另一个是 T 在一个合理的时间区间内（在当前时刻附近）。如果满足，则证人的秘密报告有效，WintessPool 把 B 作为证人的监测结果；如果不满足，则证人的秘密报告无效。

可以做一下简单的安全性分析。对于不同的监督结果 R=True 和 R‘=False，由于密码学安全哈希函数的碰撞阻力（难以找到有相同输出的两个输入）（引），一个证人很难找到一对可以作弊的 S 和 T， 使得 hash(R, T, S) = hash(R', T, S)；并且他也不能预先计算作弊的 S 和 T，因为要求 T 在合理的区间内。并且，由于密码学安全哈希函数的隐秘性（无法从输出反推输入），一个证人难以从秘密报告阶段的哈希值中窥探其他证人的监测结果。





##### 3.2.5.2 证人的随机抽取

对于一个租户和供应商的租约，WitnessPool 合约要从证人池中抽选出一些证人组成执行 SLA 的证人委员会；抽选必须是随机无偏的，以使证人不偏向租户和供应商中的任何一方。这涉及到一个安全性问题：如何在区块链上产生随机性？



**来自未来的随机性**

区块链上保存的数据可视为状态机作用了一个操作日志后到达的最终状态，因此区块链不能内生地产生随机性。否则，如果两个状态机作用了同一个操作日志，那么它们会由于某一个操作导致的状态的随机改变而到达不同的最终状态。可以从链外输入随机性到区块链中，通过使作用于状态机的日志是"随机的“。

我们参考了论文 [Blockchain based Witness Model](https://pure.uva.nl/ws/files/42160225/Blockchain_based_Witness_Model.pdf) （引）中随机抽选证人的算法，并对其做了进一步的改进，使得随机抽选更易于在实际工程中实现。WitnessPool 随机抽选算法的种子是根据区块链上未来产生的区块的哈希来计算，其随机性来源于未来时间里各方参与区块链的不确定性。具体来讲，当 FaaS 平台为一个部署订单新建一个租约时，同时记录此刻的区块号 `blockNum when new-lease `，在新建租约经过一段时间后，FaaS 平台新建一个 SLA，在 SLA 的新建过程中，就会执行证人委员会的抽选，记录新建 SLA 时的区块号为 `blockNum when new-SLA`，

由 `blockNum when new-lease ` 和 `blockNum when new-SLA` 来衍生一个位于两者之间的区块号 `pivotBlockNum`，计算`pivotBlockNum` 对应的区块以及后继 `blockNeed-1` 个区块的哈希的和，作为抽选证人的随机种子。 如图-8（链）所示。



图-8 区块链上的随机性来源

![](defaas.assets/Randomness-on-Blockchain-1617183691706.svg)





在实际应用智能合约的工程实践中，我们并不能访问到所有区块的哈希，例如以太坊的 solidity 语言只支持访问最近 256 个区块的哈希值，不在该范围的区块的哈希值为 0（引）。从新建租约到新建SLA的一段时间，我们等待未来区块的产生，但是无法控制产生多少区块，如果其间产生的新区块超过 256 个，那么太旧（不是最近 256 个）的区块的哈希信息就不能访问，也就无法把其区块哈希作为随机性来源。为了解决上述工程问题，我们设计一个 `pivotBlockNum` 来锚定哪些可以访问到有效哈希的最近区块。

```go
_pivotBlockNum = 
blockNum_when_new_SLA - ( blockNum_when_new_SLA - blockNum_when_new_lease ) / 1024 - _blockNeed;
```

只有在 ( `blockNum when SLA` - `blockNum when new-lease` ) > 1024 * 256 = 2^18 的时候，哈希信息才会消失。这是一个过于琐细的工程上的 trick，但又是保护证人逻辑的重要细节。





## 4. 算池

### 4.1 算池供应商

比特币的最初设想是网络节点是去中心化的，每个区块链网络节点都只有很小的计算能力，但是现实的发展是出现了 PoW 算力中心——矿池。在一些用博弈论等数学工具分析矿池的论文中（引），“ 加入矿池获得的收益 比单独挖矿获得的收益高”这个非常直观的印象，得到合理的建模与严格的论证。

本平台的算力市场也存在类似的结论。本平台允许任何计算设备成为供应商来出售闲置计算，只要它具备一些计算机的功能。供应商可以是一台 PC，可以是一个公有云中闲置的服务器，可以是一个具有多个计算设备的集群，还可以是一个边缘计算设备，等等。由于本平台设计了竞价机制，供应商之间存在竞争关系。可以预见，只具有单个计算设备的供应商在性能，可用性等多个方面的能力指标是不如具有多个计算设备的供应商或者多个供应商的联合。也就是说，多个供应商可以通过合作来取得相对单设备供应商的优势，这也意味着更高的收益。那么，如果本平台的算力市场能够得到发展，像矿工形成矿池一样，一些供应商也会逐渐地，自发地形成“算池”。

多个计算设备通过一些技术手段连接，组成一个算池，而对于 FaaS 平台，整个算池表现为一个独立的供应商，这种供应商可称为“**算池供应商”**（Computing-Pool Provider）。算池供应商可能是一个私有的计算机集群，也可能是一个机构在背后运作，通过汇聚广域网中其他计算设备来建立算池。如果一个算池供应商是通过吸纳开放环境中其他设备来形成自己的算池的，那么可以称为”**开放算池供应商**“（Open Computing-Pool Provider）。一些基本功能不完备（如，没有公有 IP 地址，没有安装足够的软件栈等）的计算设备（如，PC，边缘计算设备等）可以加入开放算池供应商，间接地给 FaaS 平台提供计算资源。正如同比特币网络矿工加入矿池一样，矿池里的矿工不需要运行一个比特币全节点；加入开放算池的计算设备不需要完整具备本平台要求的计算机功能，可能只需要安装并运行一个和指定算池相关的代理程序。

至此为止，在章节 3 中描述的去中心化 FaaS 平台的基础上，我们建立了更上一层的逻辑：在开放的环境中，计算设备可以通过加入开放算池供应商来出售闲置计算资源。本平台只维护了租户和供应商上的信任，还需要注意到，开放算池也有信任问题，比如算池不如实地给加入算池的计算设备发放收益等。我们认为，算池里的信任问题会被算池供应商之间竞争关系制衡并解决。在本平台的算力市场中，算池供应商，开放算池供应商之间存在竞争关系，如果一个开放算供应商不诚信，计算设备可以选择加入其他的开放算池供应商，所以，开放算池供应商对计算设备的不诚信行为有巨大的风险。



图-9 FaaS 平台，算池供应商与计算设备的关系

<img src="./defaas-imgs/Computing-Pool.svg"  />



### 4.2 适配器

虽然函数服务对调用方表现为一个 HTTP 服务，但是不同的供应商运行的函数服务的方式可能是不同的。为了能够支持各种各样的算池，我们对函数代码的表示和传输采取了适配器接口的设计，通过适配器来适配各种具体的函数运行方式，算池供应商需要实现适合于自己算池的适配器才能参与 FaaS 平台。

适配器的作用是解释如何解析租户编写函数服务以及如何在供应商处运行函数服务。如图-10（链）所示，一个适配器逻辑上包含两个部分，一个部分在租户一侧，负责把租户编写的函数服务代码转换为供应商可以解析的函数代码包，另一个部分在供应商一侧，负责解析租户通过链下部署请求发来的函数代码包并运行函数服务。

适配器带来设计上的灵活性，使得本平台可以支持多种类型的计算设备和多种类型函数服务。譬如，如果有一个算池供应商是由专门的 AI 计算设备组成的算池，擅长运行 AI 推理任务，那么该算池供应商需要先向 FaaS 平台提交适配该算池的适配器程序，这样租户在链下部署时使用适配器进行租户侧的处理，该供应商在收到租户的代码包后可以进行供应商侧的处理，然后在算池中运行函数服务。



图-10 适配器在链下部署函数服务中的作用

![](./defaas-imgs/Adapter.svg)





### 4.3 一种算池的参考设计

参与到本平台的算池供应商可以各种各样，它们可能针对不同类型的计算设备，不同的函数任务场景，应用了不同的连接方法和资源池化技术。使用者可以基于FaaS 平台实现各种类型的算池供应商，图-11（链）展示了一种基于 K8S 的算池供应商的具体设计，可供参考。



图-11 基于 K8S 的算池供应商的设计

![](./defaas-imgs/K8S-based-Computing-Pool-Provider.svg)







## 5. 实现

我们基于以太坊实现了一个 FaaS 平台的原型。

它的开源地址在 https://github.com/Oscillator-Phoenix/defaas

> 待写



## 6. 不足分析

### 6.1 没有定制区块链

本平台仅是一个去中心化应用，所设计的智能合约纯粹属于区块链的应用层，没有涉及对区块链的底层设计。

粗略来看，只包含应用逻辑的 DApp 似乎可以部署在任何一个区块链上；但实际上，DApp 并不是和区块链底层完全解耦的，DApp 许多的指标会受到区块链底层的限制，比如说安全性，性能。一种 DApp 的设计趋势是“把构建一个 DApp 当作构建一个针对该 DApp 定制的区块链”，称为 Applications-Specific Blockchains（引）。这种设计理念不同于以太坊（多个  DApp 共享争用同一个公链的资源），在根本上就解决了以太坊所面临的两个难题：扩展性，DApp与以太坊平台之间的治理冲突。

为 DApp 定制区块链而不是选择以太坊之类的共享平台的好处是显而易见的：

- 可以根据应用的特点选择合适的共识算法，设计合适的共识机制，采用适合的技术底座，进而在安全性，互操作性，吞吐量，可扩展性等多个方面达到一个很好的权衡
- 可以根据应用逻辑的需要做底层区块链的治理，而不会影响其他 DApp



### 6.2 经济危机

本平台引入了 FaaS Token 这种代币作为交换计算资源的媒介，也就同时引入资本主义经济的内生缺陷。

下面是本平台的算力市场发生经济危机的一个演绎：

1. 假设本平台上流通的 Token 的总量是一定的，Token 仅可在本平台内流通，并且不能和任何外部资产汇兑。
2. 假设所有参与者在初始时拥有等量的 Token。
3. 假设本平台的参与者数量是一定的，他们各自拥有的计算资源是不等量的，而任何时刻都有等量负载的函数服务需求。
4. 基于假设 12 3，可以推断出 Token 的流动将呈现如下趋势：一方面，对于那些拥有较少计算资源的参与者，他们往往缺少计算资源，更多可能成为租户来消费其他参与者的计算资源，更少可能成为供应商来赚取 Token，因此入不敷出。另一方面，那些拥有较多计算资源的参与者，更多可能成为供应商节出售闲置计算资源，更少可能成为租户为购买计算资源，因此只进不出。

5. FaaS 平台经过一段时间的发展与交易的进行，Token 分布将出现严重失衡。一部分计算资源富余的参与者（供应商类型）积累了绝大部分的 Token，而计算资源匮乏的参与者（租户类型）拥有的 Token 则所剩无几。供应商类型的参与者不需要购买计算资源，而租户类型已囊中羞涩无力购买，平台上的交易无以为继。这便是表现为交易停滞，通货紧缩，有效需求不足，产能相对过剩的经济危机。在这个情境下，经济危机的根本原因是天然的：计算资源的不平衡导致 Token 流动失衡。



FaaS 平台的经济系统的这种自我限制，在《资本论》中被论述为资本主义内在界限的两种（引）。

- 货币是生产的界限。资本主义生产的最基本特征是，货币的增殖，不同产业之间的关系全部以货币为媒介。生产力的发动，也先要将货币投放。当因为货币的流通量不足而无法以货币进行结算，资本主义生产就碰到了它的界限。而这一界限是自己设定的，所以采取超发货币突破这一界限。（引）

- 使用价值的生产受到交换价值的限制。使用价值是真实的感性财富。由于资本主义生产追求剩余价值，如果某种使用价值带来不了剩余价值，这种使用价值将不会被生产。说明资本主义生产，一方面带来人的实际需要的满足，如果他的这种实际需要的满足不能带来剩余价值，生产就不存在。（引）

市场经济系统，它内在地具有对等交易的理性过程和经济危机的非理性结果；区块链技术可以令市场经济中理性的部分更加理性，但对非理性的部分则难有作为。上述对经济危机的分析，解释了第四章中“证人的监测收益来自平台的增发”这一设计，这一设计也仅仅是缓解货币的流向失衡，不从根本上解决问题。



### 6.3 不支持弹性 FaaS

如 3.1.2 中所述。

> 待写





> ### 6.4 简化处理了 SLA
>
> - 证人如何检测出供应商在运行函数？
>
> - 需要给函数服务预先注入供证人检测钩子（可能是一个哈希字符串的路径），并且这种钩子不能被供应商嗅探到
>
> - 证人如何检测出供应商如实运行函数？
>
>   - 需要一些函数的测试例子，最好是可以自动化生成的
>
> - 证人如何检测出供应商有没有如实提供计算资源规格？
>
>   - 有没有一种算法或密码学函数 F，通过一个输入 X 给 F，得到输出 Y = F（X），满足以下条件：
>     - 计算 Y 要耗费 CPU 和 大量内存，可使不同规格的计算资源有明显的计算时间的不同（要求供应商在规定时间内返回结果） 
>     - 验证 Y 是 X 的结果可以非常快速（让证人可以快速验证）
>
>   我想到的是随机化验证矩阵乘法：https://blog.51cto.com/4747857/1577629





## 7. 研究现状和相关工作（提纲）

- https://akash.network/
- https://sonm.com
- Nebula: A Blockchain Based Decentralized Sharing Computing Platform https://link.springer.com/chapter/10.1007%2F978-981-15-2777-7_58
- ChainFaaS: An Open Blockchain-BasedServerless Platform

- Golem https://github.com/golemfactory





## 8. 结论

本文介绍了一个 FaaS 平台，它的特点是开放，公平。





## 参考文献

- 1.1
  - A Mars, J., Tang, L., Skadron, K., Soffa, M.L., Hundt, R.: Increasing  utilization in modern warehouse-scale computers using bubble-up. IEEE  Micro **32**(3), 88–99 (2012).  https://doi.org/10.1109/MM.2012.22
  - B A Blockchain based Witness Model for Trustworthy Cloud Service Level Agreement Enforcement

- 1.2
  - https://ethereum.org/en/developers/docs/smart-contracts/

- 1.2
  - A Next-Generation Smart Contract and Decentralized Application Platform https://ethereum.org/en/whitepaper/

  - Ethereum Yellow Paper: a formal specification of Ethereum, a programmable blockchain https://ethereum.github.io/yellowpaper/paper.pdf



-----------



